/**
 * AUDITORÃA CRÃTICA: EXPLOIT ECONÃ“MICO DE REEMBOLSOS
 * 
 * Detecta si hubo generaciÃ³n indebida de fuegos por rifas canceladas
 * donde el host no devolviÃ³ el pot_fires acumulado.
 * 
 * Ejecutar: node backend/scripts/audit-raffle-refund-exploit.js
 */

const { Pool } = require('pg');

const pool = new Pool({
  connectionString: process.env.DATABASE_PUBLIC_URL || process.env.DATABASE_URL,
  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false
});

async function auditRaffleRefundExploit() {
  const client = await pool.connect();
  
  try {
    console.log('========================================');
    console.log('ðŸ” AUDITORÃA: EXPLOIT REEMBOLSOS RIFAS');
    console.log('========================================\n');

    // ========================================
    // QUERY 1: Rifas canceladas con pot_fires > 0
    // ========================================
    console.log('ðŸ“Š QUERY 1: Rifas canceladas con pot no devuelto\n');
    
    const query1 = `
      SELECT 
        r.id,
        r.code,
        r.host_id,
        u.username as host_username,
        r.mode,
        r.status,
        r.pot_fires,
        r.pot_coins,
        r.cost_per_number,
        r.cancelled_at,
        r.ended_at,
        r.created_at,
        (SELECT COUNT(*) FROM raffle_numbers WHERE raffle_id = r.id AND state = 'sold') as sold_numbers
      FROM raffles r
      LEFT JOIN users u ON u.id = r.host_id
      WHERE r.status = 'cancelled'
        AND (r.pot_fires > 0 OR r.pot_coins > 0)
      ORDER BY r.cancelled_at DESC;
    `;
    
    const result1 = await client.query(query1);
    
    if (result1.rows.length === 0) {
      console.log('âœ… NO SE DETECTARON RIFAS CANCELADAS CON POT > 0');
      console.log('   â†’ No hay evidencia de exploit (o todas se reembolsaron correctamente)\n');
    } else {
      console.log(`âš ï¸  DETECTADAS ${result1.rows.length} RIFAS CANCELADAS CON POT NO DEVUELTO:\n`);
      
      let totalExploitFires = 0;
      let totalExploitCoins = 0;
      
      result1.rows.forEach((row, idx) => {
        console.log(`${idx + 1}. Rifa ${row.code} (ID: ${row.id})`);
        console.log(`   Host: ${row.host_username} (${row.host_id})`);
        console.log(`   Modo: ${row.mode} | Status: ${row.status}`);
        console.log(`   POT NO DEVUELTO: ${row.pot_fires} ðŸ”¥ | ${row.pot_coins} ðŸª™`);
        console.log(`   NÃºmeros vendidos: ${row.sold_numbers}`);
        console.log(`   Cancelada: ${row.cancelled_at}`);
        console.log('');
        
        totalExploitFires += parseFloat(row.pot_fires) || 0;
        totalExploitCoins += parseFloat(row.pot_coins) || 0;
      });
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log(`ðŸ’° TOTAL FUEGOS GENERADOS INDEBIDAMENTE: ${totalExploitFires.toFixed(2)} ðŸ”¥`);
      console.log(`ðŸ’° TOTAL MONEDAS GENERADAS INDEBIDAMENTE: ${totalExploitCoins.toFixed(2)} ðŸª™`);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    }

    // ========================================
    // QUERY 2: Transacciones de reembolso
    // ========================================
    console.log('ðŸ“Š QUERY 2: Historial de transacciones de reembolso\n');
    
    const query2 = `
      SELECT 
        wt.id,
        wt.user_id,
        u.username,
        wt.type,
        wt.amount,
        wt.currency,
        wt.reference,
        wt.description,
        wt.created_at
      FROM wallet_transactions wt
      LEFT JOIN users u ON u.id = wt.user_id
      WHERE wt.type IN ('raffle_number_refund', 'raffle_refund_from_pot', 'raffle_refund_platform_fee')
      ORDER BY wt.created_at DESC
      LIMIT 50;
    `;
    
    const result2 = await client.query(query2);
    
    if (result2.rows.length === 0) {
      console.log('âš ï¸  NO SE ENCONTRARON TRANSACCIONES DE REEMBOLSO');
      console.log('   â†’ Nunca se ha cancelado una rifa con reembolso\n');
    } else {
      console.log(`âœ… ENCONTRADAS ${result2.rows.length} TRANSACCIONES DE REEMBOLSO:\n`);
      
      const refundTypes = {
        raffle_number_refund: 0,
        raffle_refund_from_pot: 0,
        raffle_refund_platform_fee: 0
      };
      
      result2.rows.forEach((row, idx) => {
        if (idx < 10) { // Mostrar solo las primeras 10
          console.log(`${idx + 1}. ${row.type}`);
          console.log(`   Usuario: ${row.username} (${row.user_id})`);
          console.log(`   Monto: ${row.amount} ${row.currency}`);
          console.log(`   Ref: ${row.reference}`);
          console.log(`   Fecha: ${row.created_at}`);
          console.log('');
        }
        
        refundTypes[row.type] = (refundTypes[row.type] || 0) + 1;
      });
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ðŸ“Š RESUMEN POR TIPO:');
      console.log(`   raffle_number_refund: ${refundTypes.raffle_number_refund} (reembolsos a usuarios)`);
      console.log(`   raffle_refund_from_pot: ${refundTypes.raffle_refund_from_pot} (host devuelve pot) â† NUEVO FIX`);
      console.log(`   raffle_refund_platform_fee: ${refundTypes.raffle_refund_platform_fee} (admin devuelve comisiÃ³n)`);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      
      if (refundTypes.raffle_refund_from_pot === 0) {
        console.log('ðŸš¨ CRÃTICO: NO HAY TRANSACCIONES raffle_refund_from_pot');
        console.log('   â†’ TODOS los reembolsos anteriores usaron flujo INCORRECTO');
        console.log('   â†’ Hosts NO devolvieron pot_fires\n');
      } else {
        console.log('âœ… Se detectan transacciones del nuevo flujo (post-fix)\n');
      }
    }

    // ========================================
    // QUERY 3: Hosts beneficiados del exploit
    // ========================================
    console.log('ðŸ“Š QUERY 3: Hosts que se beneficiaron del exploit\n');
    
    const query3 = `
      SELECT 
        u.id,
        u.username,
        u.tg_id,
        w.fires_balance,
        w.coins_balance,
        (
          SELECT COUNT(*) 
          FROM raffles r 
          WHERE r.host_id = u.id 
            AND r.status = 'cancelled' 
            AND (r.pot_fires > 0 OR r.pot_coins > 0)
        ) as cancelled_raffles_with_pot,
        (
          SELECT COALESCE(SUM(r.pot_fires), 0) 
          FROM raffles r 
          WHERE r.host_id = u.id 
            AND r.status = 'cancelled' 
            AND r.pot_fires > 0
        ) as total_kept_fires,
        (
          SELECT COALESCE(SUM(r.pot_coins), 0) 
          FROM raffles r 
          WHERE r.host_id = u.id 
            AND r.status = 'cancelled' 
            AND r.pot_coins > 0
        ) as total_kept_coins
      FROM users u
      JOIN wallets w ON w.user_id = u.id
      WHERE EXISTS (
        SELECT 1 FROM raffles r 
        WHERE r.host_id = u.id 
          AND r.status = 'cancelled' 
          AND (r.pot_fires > 0 OR r.pot_coins > 0)
      )
      ORDER BY total_kept_fires DESC, total_kept_coins DESC;
    `;
    
    const result3 = await client.query(query3);
    
    if (result3.rows.length === 0) {
      console.log('âœ… NO SE DETECTARON HOSTS BENEFICIADOS');
      console.log('   â†’ No hay usuarios que hayan cancelado rifas con pot > 0\n');
    } else {
      console.log(`âš ï¸  DETECTADOS ${result3.rows.length} HOSTS BENEFICIADOS:\n`);
      
      result3.rows.forEach((row, idx) => {
        console.log(`${idx + 1}. ${row.username} (TG: ${row.tg_id})`);
        console.log(`   User ID: ${row.id}`);
        console.log(`   Balance actual: ${row.fires_balance} ðŸ”¥ | ${row.coins_balance} ðŸª™`);
        console.log(`   Rifas canceladas con pot: ${row.cancelled_raffles_with_pot}`);
        console.log(`   FUEGOS NO DEVUELTOS: ${row.total_kept_fires} ðŸ”¥`);
        console.log(`   MONEDAS NO DEVUELTAS: ${row.total_kept_coins} ðŸª™`);
        console.log('');
      });
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    }

    // ========================================
    // RESUMEN FINAL Y RECOMENDACIONES
    // ========================================
    console.log('========================================');
    console.log('ðŸ“‹ RESUMEN Y RECOMENDACIONES');
    console.log('========================================\n');
    
    if (result1.rows.length > 0) {
      console.log('ðŸš¨ EXPLOIT CONFIRMADO - ACCIÃ“N REQUERIDA:\n');
      console.log('1. Hosts mantuvieron pot_fires de rifas canceladas');
      console.log('2. Sistema generÃ³ fuegos indebidamente');
      console.log('3. Se requiere rollback manual\n');
      
      console.log('ðŸ’¡ ACCIÃ“N SUGERIDA:\n');
      console.log('-- Para cada host identificado, ejecutar:');
      console.log('UPDATE wallets SET fires_balance = fires_balance - <total_kept_fires> WHERE user_id = <host_id>;');
      console.log('INSERT INTO wallet_transactions (...) VALUES (..., \'admin_correction_exploit\', ...);\n');
      
      console.log('âš ï¸  IMPORTANTE: Revisar cada caso individualmente antes de aplicar rollback\n');
    } else {
      console.log('âœ… SISTEMA LIMPIO - NO SE DETECTÃ“ EXPLOIT\n');
      console.log('Todas las rifas canceladas fueron reembolsadas correctamente\n');
    }
    
    console.log('========================================');
    console.log('âœ… AUDITORÃA COMPLETADA');
    console.log('========================================\n');

  } catch (error) {
    console.error('âŒ ERROR EN AUDITORÃA:', error);
    throw error;
  } finally {
    client.release();
    await pool.end();
  }
}

// Ejecutar auditorÃ­a
auditRaffleRefundExploit()
  .then(() => {
    console.log('Script finalizado exitosamente');
    process.exit(0);
  })
  .catch((error) => {
    console.error('Script finalizado con errores:', error);
    process.exit(1);
  });
